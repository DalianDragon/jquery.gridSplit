// Author: Graham Dixon 
// Contact: gdixon@assetinfo.co.uk 
// Copyright: (c) 2015 Graham Dixon (assetinfo(MML))
// Script: jquery.gridsplit.min.js - v.0.0.1 
// Licensed: MIT 
// Depends on: jQuery && jQuery-ui, underscore, bootstrap 3.*!function(a){"function"==typeof define&&define.amd?define(["../bower_components/jquery/src/jquery","../bower_components/underscore/underscore"],a):a(jQuery,_)}(function(a,b){a.fn.gridsplit=function(b){var d,e=function(e){void 0==a(e).data("grid")?(d=new c(e,b),a(e).data("grid",d)):"undefined"!=typeof b?"undefined"!=typeof b.data?d=e.data("grid").init(e,b):"undefined"!=typeof b.setMeta?(d=e.data("grid"),d.setMeta(b.setMeta,!1)):d=e.data("grid"):d=e.data("grid")};return e(this),d};var c=function(c,d){var e=this,f={horizRail:a("<div/>").addClass("horizrail"),vertRail:a("<div/>").addClass("vertrail"),gridColClass:"column",gridCellClass:"gridCell",innerGridClass:"inner-grid",insideCellClass:"insideCell",hasChildrenClass:"hasChildren",resizableClass:"isResizable",draggingClass:"dragging",data:"",parentGrid:"",nestedIn:"",resizable:!0,horizMin:5,vertMin:2,hideBorder:{border:"0px solid #000"}};e.init=function(b,c){var d=this;return this.settings={},this.settings=a.extend({},f,c),this.id=b.attr("id"),this.$el=a("#"+this.id),this.el=this.$el[0],this.focusGrid=this.id,this.gridsColumns=[],this.gridsCells=[],this.gridsStructure=[],this.metaAt={},a("#"+this.id+" ."+this.settings.innerGridClass).remove(),this.elInner=a("<div />").addClass(this.settings.innerGridClass).appendTo(this.$el),1==this.settings.splitCellInColumn&&(this.settings.useInsideCell=this.settings.insideCellClass+""+this.settings.nestedIn),""==this.settings.data?(this.gridsStructure[0]="need to set",this.addColumn(0),this.gridsStructure[0][0]="need to set",this.addCell(0,0),1==this.settings.splitCellInColumn&&this.addColumn(0)):this.buildGrid(this.settings.data),a(window).on("resize",function(){d.centerInner(d)}),this},e.buildGrid=function(a,c){var d=this;b.each(a,function(a,e){isNaN(e)||(d.gridsStructure[e]="need to set",d.addColumn(e,c,!0),d.gridsColumns[e].css("float","left"),d.countCells(a)>0?b.each(a,function(a,b){if(!isNaN(b)&&(d.addCell(e,b),"object"==typeof a[0])){d.gridsCells[e][b].addClass(d.settings.hasChildrenClass);{d.splitCellInColumn(d.gridsCells[e][b],e,b,a)}}}):d.addCell(e,0))}),d.setMeta(a,!0)},e.setMeta=function(a,c){var d=this;return b.each(a,function(a,e){if(!isNaN(e)){if("undefined"!=typeof a.c)var f=a.c.w;else var f=null;d.gridsColumns[e].css("width",f),d.resizeColumn(e,f),d.countCells(a)>0&&b.each(a,function(a,b){isNaN(b)||"undefined"!=typeof d.gridsCells[e][b]&&(d.gridsCells[e][b].css("height",a.h),d.resizeCell(e,b,a.h)),"object"==typeof a[0]&&c!==!0&&"undefined"!=typeof d.gridsCells[e][b]&&d.gridsCells[e][b].data("grid").setMeta(a,!1)})}}),this},e.countCells=function(a){var c=0;return b.each(a,function(a,b){isNaN(b)||c++}),c},e.addCell=function(b,d,e){return"undefined"==typeof b||"undefined"==typeof d?this:(this.gridsStructure.length-1<b&&(b=this.gridsStructure.length-1),"need to set"==this.gridsStructure[b][d]?(c=a('<div class="'+this.settings.gridCellClass+" "+(1==this.settings.splitCellInColumn?this.settings.insideCellClass+" "+this.settings.useInsideCell:"")+'" ></div>'),"undefined"!=typeof e?c.insertAfter(e):c.appendTo(this.gridsColumns[b]),this.gridsStructure[b][d]=!0,this.gridsCells[b][d]=c,this.addControls(this.gridsCells[b][d],b,d)):this.gridsStructure[b].length>d?this.splitAt(b,d):(b<this.gridsStructure.length-1?this.splitAt(this.gridsStructure.length,d):this.splitAt(b,this.gridsStructure[b].length-1),delete this.gridsStructure[b][d]),this)},e.addColumn=function(b,c,d){var e=this;if("undefined"!=typeof b){if("need to set"==this.gridsStructure[b]){var f=a('<div class="'+this.settings.gridColClass+'" ></div>');"undefined"!=typeof c?f.insertAfter(c):f.appendTo(this.elInner),this.gridsStructure[b]=[],this.gridsCells[b]=[],this.gridsColumns[b]=f.data("tpe","c"),this.addControls(this.gridsColumns[b],b)}else this.gridsStructure.length>b?this.splitAt(b):(this.splitAt(this.gridsStructure.length-1),delete this.gridsStructure[b]);return 1==!d&&(clearTimeout(e.timeoutFP),e.timeoutFP=setTimeout(function(){e.forcePerWidth()})),this}},e.splitAt=function(a,c,d){var e=this;if("undefined"!=typeof c){if("undefined"!=typeof d)return this.gridsCells[a][c].addClass(this.settings.hasChildrenClass),this.splitCellInColumn(this.gridsCells[a][c],a,c);if(c+1==this.gridsStructure[a].length)this.gridsStructure[a][c+1]="need to set",this.addCell(a,c+1);else{var f=[],g={},h=[];g.c=e.metaAt[a].c,b.each(this.gridsCells[a],function(b,d){d>=c+1?(f[d+1]=e.gridsCells[a][d],g[d+1]=e.metaAt[a][d],h[d+1]=e.gridsStructure[a][d]):(f[d]=e.gridsCells[a][d],g[d]=e.metaAt[a][d],h[d]=e.gridsStructure[a][d])}),this.gridsCells[a]=f,this.metaAt[a]=g,this.gridsStructure[a]=h,this.gridsStructure[a][c+1]="need to set",this.addCell(a,c+1,this.gridsCells[a][c])}var i=this.gridsCells[a][c],j=this.gridsCells[a][c+1],k=(this.gridsCells[a].length,this.halfOf(i,j,0,"h",this.gridsCells[a]));b.each(this.gridsCells[a],function(b,c){e.resizeCell(a,c,k+"%")})}else{if(a+1==this.gridsStructure.length)this.gridsStructure[a+1]="need to set",this.addColumn(a+1);else{var f=[],g={},l=[],h=[];b.each(this.gridsColumns,function(b,c){c>=a+1?(f[c+1]=e.gridsColumns[c],g[c+1]=e.metaAt[c],l[c+1]=e.gridsCells[c],h[c+1]=e.gridsStructure[c]):(f[c]=e.gridsColumns[c],g[c]=e.metaAt[c],l[c]=e.gridsCells[c],h[c]=e.gridsStructure[c])}),this.gridsColumns=f,this.metaAt=g,this.gridsCells=l,this.gridsStructure=h,this.gridsStructure[a+1]="need to set",this.addColumn(a+1,this.gridsColumns[a])}var i=this.gridsColumns[a],j=this.gridsColumns[a+1],m=this.gridsColumns[a].width(),n=this.halfOf(i,j,m,"w");this.resizeColumn(a,n),this.resizeColumn(a+1,n),this.gridsStructure[a+1][0]="need to set",this.addCell(a+1,0)}return this},e.splitCellInColumn=function(a,b,c,d){return this.splitCellInColumn!==!0&&(a.attr("id",(""!==this.settings.nestedIn?this.settings.nestedIn+"-"+this.id:this.id)+"-"+b+c).css(this.settings.hideBorder).off("click").gridsplit({parentGrid:this,parentsX:b,parentsY:c,splitCellInColumn:!0,nestedIn:""!==this.settings.nestedIn?this.settings.nestedIn+"-"+this.id:this.id,data:"undefined"!=typeof d?d:"",resizable:this.settings.resizable}),this.gridsStructure[b][c]={},this.gridsStructure[b][c]=a.data("grid").gridsStructure,"undefined"==typeof this.metaAt[b]&&(this.metaAt[b]={},this.metaAt[b].c={}),this.metaAt[b][c]=a.data("grid").metaAt),a.data("grid")},e.delCell=function(c,d){var e=this,f=[],g={},h=[],i=this.gridsCells[c][d];return"undefined"!=typeof this.gridsColumns[c]&&"undefined"!=typeof this.gridsCells[c][d]&&this.gridsColumns.length>0&&(this.gridsCells[c].length>1?(g.c=e.metaAt[c].c,b.each(this.gridsCells[c],function(a,b){b>d?(f[b-1]=e.gridsCells[c][b],g[b-1]=e.metaAt[c][b],h[b-1]=e.gridsStructure[c][b]):b!==d&&(f[b]=e.gridsCells[c][b],g[b]=e.metaAt[c][b],h[b]=e.gridsStructure[c][b])}),a(i).remove(),this.gridsCells[c]=f,this.metaAt[c]=g,this.gridsStructure[c]=h,this.forcePerHeight(c)):this.delColumn(c)),this},e.delColumn=function(c){var d=this,e=[],f={},g=[],h=[],i=this.gridsColumns[c];return"undefined"!=typeof this.gridsColumns[c]&&(b.each(this.gridsColumns,function(a,b){b>c?(e[b-1]=d.gridsCells[b],f[b-1]=d.metaAt[b],g[b-1]=d.gridsStructure[b],h[b-1]=d.gridsColumns[b]):b!==c&&(e[b]=d.gridsCells[b],f[b]=d.metaAt[b],g[b]=d.gridsStructure[b],h[b]=d.gridsColumns[b])}),h.length>=1?(a(i).remove(),this.gridsCells=e,this.metaAt=f,this.gridsStructure=g,this.gridsColumns=h,this.forcePerWidth()):this.$el.find(".vertRail").remove()),this},e.delAt=function(a,b){return"undefined"==typeof b?this.delColumn(a):this.delCell(a,b)},e.addRail=function(b,c,d){var e=this;if(1==this.settings.resizable&&b.addClass(this.settings.resizableClass),"c"==a(b).data("tpe")){if(0!==c){var f=(this.settings.gridColClass,this.settings.vertRail),g=f.clone();g.appendTo(b),g.draggable({axis:"x",containment:b.parent(),start:function(b,c){var d=a(this).closest("."+e.settings.gridColClass).prevAll("."+e.settings.gridColClass).length;if("undefined"!=typeof e.gridsColumns[d]&&0!==d){g.data("x",d);{e.gridsColumns[d-1]}g.origRight=e.gridsColumns[d].offset().left-e.$el.offset().left,g.origLeft=e.gridsColumns[d-1].offset().left-e.$el.offset().left,g.origWidth=g.origRight-g.origLeft,a(this).addClass(e.settings.draggingClass)}else g.remove()},stop:function(){var b=a(this).offset().left,d=b-g.origWidth-e.$el.offset().left,f=d+g.origWidth-g.origLeft,h=e.perOfWidth(f);e.gridsColumns[a(this).data("x")-1].css("width",h);var i=e.gridsColumns.length-a(this).data("x"),j=(f-g.origWidth)/i;if(i>0){for(c=a(this).data("x");c<e.gridsColumns.length;c++){var k=e.gridsColumns[c].outerWidth(),l=k-j;e.gridsColumns[c].css("width",e.perOfWidth(l))}e.forcePerWidth()}a(this).css("left","auto")}})}}else if(0!==d){var f=(this.settings.gridCellClass,this.settings.horizRail),g=f.clone();g.appendTo(b);var e=this;g.draggable({containment:b.parent(),axis:"y",start:function(b,c){var d=a(this).closest("."+e.settings.gridCellClass).prevAll("."+e.settings.gridCellClass).length,f=a(this).closest("."+e.settings.gridColClass).prevAll("."+e.settings.gridColClass).length;"undefined"!=typeof e.gridsCells[f][d]&&0!==d?(g.data("x",f),g.data("y",d),a(this).addClass(e.settings.draggingClass)):g.remove()},stop:function(b,c){var d=c.position.top-c.originalPosition.top,f=a(this).data("y"),g=a(this).data("x"),h=(a(this).offset().top,e.gridsCells[g][f-1].outerHeight()+d),i=e.gridsColumns[g].outerHeight(),j=e.perOfHeight(h,i);e.gridsCells[g][f-1].css("height",j),h=e.gridsCells[g][f].outerHeight()-d,j=e.perOfHeight(h,i),e.gridsCells[g][f].css("height",j),a(this).css("top","auto"),e.forcePerHeight(g)}})}},e.resizeColumn=function(a,b){"undefined"==typeof this.metaAt&&(this.metaAt={}),"undefined"==typeof this.metaAt[a]&&(this.metaAt[a]={},this.metaAt[a].c={});var c={w:b};this.setMetaAt(a,null,c)},e.resizeCell=function(a,b,c){"undefined"==typeof this.metaAt[a]&&(this.metaAt[a]={},this.metaAt[a].c={}),"undefined"==typeof this.metaAt[a][b]&&(this.metaAt[a][b]={});var d={h:c};this.setMetaAt(a,b,d)},e.setMetaAt=function(b,c,d){"undefined"==typeof this.metaAt[b]&&(this.metaAt[b]={},this.metaAt[b].c={}),null===c?this.metaAt[b].c=a.extend({},this.metaAt[b].c,d):("undefined"==typeof this.metaAt[b][c]&&(this.metaAt[b][c]={}),this.metaAt[b][c]=a.extend({},this.metaAt[b][c],d))},e.addControls=function(b,c,d){var e=this;if("c"==a(b).data("tpe")){var f=(this.settings.gridColClass,"c");0!==c&&1==this.settings.resizable&&this.addRail(b,c,d)}else{var f=(this.settings.gridCellClass,"r");0!==d&&1==this.settings.resizable&&this.addRail(b,c,d)}b.on("click",function(){e.clickThis(this,f)})},e.clickThis=function(b,c){if("c"==c){this.gridCol}else{this.gridCell,a(b).toggleClass("black")}},e.halfOf=function(b,c,d,e,f){if("w"==e)if("undefined"!=typeof f)var g=this.perOfWidthEls(f);else{var g=this.perOfWidth(d/2);a(b).css({width:g,"float":"left"}),a(c).css({width:g,"float":"left"})}else if("h"==e)var g=this.perOfHeightEls(f);return g},e.perOfWidth=function(a){var b=100/this.$el.outerWidth()*a;return b+"%"},e.perOfWidthEls=function(a){var b=a.$el.find("."+a.settings.innerGridClass).first().children("."+a.settings.gridColClass),c=b.length,d=100/c;return b.css({width:d+"%","float":"left"}),d},e.perOfHeight=function(a,b){var c=100/("undefined"!=typeof b?b:this.$el.outerHeight())*a;return c+"%"},e.perOfHeightEls=function(b){var c,d=b.length,e=100/d;if(1==this.settings.splitCellInColumn)c="."+this.settings.useInsideCell;else{var f=":not(.",g=")";c="."+this.settings.gridCellClass+f+this.settings.insideCellClass+g}return a(b[0]).parent().find(c).css("height",e+"%"),e},e.equalPers=function(a,b,c){for(var d=a.length,f=0,g=0;d--;)g=0==c?this.settings.vertMin:this.settings.horizMin,a[d]<g&&(a[d]=g),f+=a[d];for(x=0;x<a.length;x++)a[x]=b/f*a[x];return a=e.percentageRounding(a,b)},e.percentageRounding=function(a,b){function c(a,b){return Math.abs(a-b)/a}for(var d,e,f,g,h=a.length,i=0,j=0,k=[],l=a.length,m=[];h--;)j+=k[h]=Math.round(a[h]);for(d=b>j?1:-1;j!==b;){for(h=0;l>h;h++)e=h===l-1?0:h+1,g=c(a[e],k[e]+d),f=c(a[h],k[h]+d),f>g&&(i=e);k[i]+=d,j+=d}for(h=0;l>h;h++)m[h]=k[h]&&Math.abs(a[h]-k[h])/a[h];for(h=0;l>h;h++)for(i=0;l>i;i++)if(i!==h){var n=c(a[h],k[h]+1)+c(a[i],k[i]-1),o=c(a[h],k[h]-1)+c(a[i],k[i]+1),p=m[h]+m[i];p>n&&(k[h]=k[h]+1,k[i]=k[i]-1,m[h]=k[h]&&Math.abs(a[h]-k[h])/a[h],m[i]=k[i]&&Math.abs(a[i]-k[i])/a[i]),p>o&&(k[h]=k[h]-1,k[i]=k[i]+1,m[h]=k[h]&&Math.abs(a[h]-k[h])/a[h],m[i]=k[i]&&Math.abs(a[i]-k[i])/a[i])}return k},e.centerInner=function(b){var c="undefined"!=typeof b?b:this;setTimeout(function(){var b=0;c.elInner.children("."+c.settings.gridColClass).each(function(){b+=a(this).outerWidth(!0)}),b<c.elInner.width()&&c.elInner.css("padding-left",(c.elInner.width()-b)/2+"px")})},e.forcePerWidth=function(){var c=[],d=this;b.each(this.gridsColumns,function(b,e){c.push(parseInt(d.perOfWidth(a(b).width())))});var e=this.equalPers(c,100,0);b.each(this.gridsColumns,function(b,c){a(b).css({width:e[c]+"%"}),d.resizeColumn(c,e[c]+"%")})},e.forcePerHeight=function(c){var d=[],e=this,f=this.gridsColumns[c];if("undefined"!=typeof f){b.each(e.gridsCells[c],function(b,c){d.push(parseInt(e.perOfHeight(a(b).height(),f.height())))});var g=e.equalPers(d,100,1);b.each(e.gridsCells[c],function(b,d){a(b).css({height:g[d]+"%"}),e.resizeCell(c,d,g[d]+"%")})}},e.returnStructure=function(){return JSON.stringify(this.gridsStructure)},e.returnMeta=function(){return JSON.stringify(this.metaAt)},e.returnCells=function(){return this.gridsCells},e.parent=function(){return""===this.settings.parentGrid?this:this.settings.parentGrid},e.destroy=function(a){return this.$el.empty().removeData("grid"),a},e.init(c,d)}});